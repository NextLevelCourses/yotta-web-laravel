name: ðŸš€ Demo Aksara Yotta Deployment

on:
  push:
    branches: [master] # Deploy only on push to master
    paths:
      # === Laravel Core ===
      - "app/**"
      - "bootstrap/**"
      - "config/**"
      - "routes/**"
      - "artisan"
      
      # === Deployment & Assets ===
      - "public/**"
      - "resources/**"
      - "storage/**"
      
      # === Database Schema ===
      - "database/**"

      # === Dependency & Config ===
      - "composer.json"
      - "composer.lock"

      # === Optional JS build config files  ===
      - "package.json"
      - "vite.config.js"
      - "README.md"
      - "tests/**"
      - "makefile"

    # paths-ignore:
    #   - "public/assets/**" # For saving time ignore assets folder

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Verify repo contents
        run: |
          echo "âœ… Repo successfully checked out."
          ls -lah

      # Step 2: FTP Deployment
      - name: ðŸ“¤ Deploy Laravel via FTP
        id: ftp-deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@4.0.0 # for exclude, reference the action directly from GitHub Issues https://github.com/SamKirkland/FTP-Deploy-Action/issues/157
        with:
          server: 46.202.138.81 # Gunakan IP server, jangan pakai ftp://
          username: u446621527.demoday.aksarayotta.com
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: "/domains/demoday.aksarayotta.com/public_html"

          exclude: |
            # === Git & CI files ===
            **/.git*
            **/.github*
            **/.gitignore
            **/.gitattributes

            # === Node & Build Cache ===
            **/node_modules/**
            **/package-lock.json

            # === Test & Local Dev ===
            **/tests/**
            **/phpunit.xml
            **/docker-compose.yml
            **/dockerfile
            **/makefile

            # === Logs & Temp Cache ===
            **/storage/logs/**
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/framework/views/**

            # === Assets folder ===
            **/public/assets/**

            # === Documentation / Non-production ===
            **/LICENSE
            **/README.md

      - name: âŒ Check FTP result
        if: steps.ftp-deploy.outcome != 'success'
        run: |
          echo "âŒ ERROR: FTP login or upload failed. Please check FTP credentials or server availability."
          exit 1

      - name: âœ… Confirm FTP upload
        if: steps.ftp-deploy.outcome == 'success'
        run: echo "âœ… FTP upload finished to /domains/demoday.aksarayotta.com/public_html"

      # Step 3: Run Laravel optimization
      - name: ðŸ› ï¸ Run Laravel optimization (SSH)
        if: steps.ftp-deploy.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 46.202.138.81
          username: u446621527
          port: 65002
          password: ${{ secrets.FTP_PASSWORD }}
          script: |
            set -x
            echo "ðŸš€ Connected to server: $(hostname)"
            cd /domains/demoday.aksarayotta.com/public_html

            echo "ðŸ—„ï¸ Running database migrations..."
            # php artisan migrate --force >> jika diperlukan 

            echo "ðŸ§¹ Clearing caches..."
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear

            echo "âš¡ Rebuilding caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "âœ… Deployment finished successfully!"
