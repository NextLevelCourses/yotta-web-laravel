description: "Create Laravel .env file and generate APP_KEY"

steps:
  - run:
      name: Generate .env with APP_KEY
      command: |
        set -e
        echo "⚙️ Generating .env file..."

        # Hapus .env lama kalau ada
        [ -f .env ] && rm -f .env

        # Daftar variable wajib
        REQUIRED_KEYS=(
          APP_NAME
          APP_DEBUG
          APP_ENV
          APP_URL
          CACHE_DRIVER
          DB_CONNECTION
          DB_DATABASE
          DB_HOST
          DB_USERNAME
          DB_PASSWORD
          DB_PORT
          MAIL_FROM_NAME
          MAIL_MAILER
          QUEUE_CONNECTION
          SESSION_DRIVER
        )

        for key in "${REQUIRED_KEYS[@]}"; do
          value=${!key:-}
          if [ -z "$value" ]; then
            echo "❌ Missing required environment variable: $key"
            exit 1
          fi
          echo "$key=$value" >> .env
        done

        # Generate APP_KEY
        echo "🔑 Generating Laravel APP_KEY..."
        KEY=$(docker exec yotta-dashboard php artisan key:generate --show)
        echo "APP_KEY=$KEY" >> .env
        echo "✅ APP_KEY generated and injected: $KEY"

        # Copy ke container
        docker cp .env yotta-dashboard:/var/www/.env

        # Clear & cache konfigurasi
        docker exec yotta-dashboard php artisan config:clear
        docker exec yotta-dashboard php artisan config:cache

        # Preview .env di container (mask APP_KEY)
        docker exec yotta-dashboard cat /var/www/.env | sed 's/APP_KEY=.*/APP_KEY=***masked***/'

        echo "✅ .env fully ready in container"