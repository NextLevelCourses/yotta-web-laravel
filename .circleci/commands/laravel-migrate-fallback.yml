description: "Run Laravel Migrations with fallback (Staging only)"
steps:
  - run:
      name: Laravel Migrate with Fallback
      command: |
        CONTAINER="${CONTAINER_NAME:-yotta-dashboard}"
        echo "üóÑÔ∏è Starting Laravel migrations in container '$CONTAINER' at $(date)"

        if ! docker ps --format '{{.Names}}' | grep -q "^$CONTAINER\$"; then
          echo "‚ùå Container $CONTAINER not running."
          exit 1
        fi

        echo "‚û°Ô∏è Running migration..."
        if docker exec $CONTAINER php artisan migrate --force; then
          echo "‚úÖ Migrations completed successfully at $(date)"
        else
          echo "‚ö†Ô∏è Migration failed! Attempting rollback and retry (staging only)..."

          if docker exec $CONTAINER php artisan migrate:rollback --force; then
            echo "‚ôªÔ∏è Rollback successful."
          else
            echo "‚ö†Ô∏è Rollback failed!"
          fi

          echo "üîÑ Retrying migration..."
          if docker exec $CONTAINER php artisan migrate --force; then
            echo "‚úÖ Migration succeeded after rollback & retry."
          else
            echo "‚ùå Migration still failed after retry!"
            docker exec $CONTAINER php artisan migrate:status || echo "‚ö†Ô∏è Could not fetch migration status."
            exit 1
          fi
        fi

        echo "üìã Current migration status:"
        docker exec $CONTAINER php artisan migrate:status || echo "‚ö†Ô∏è Failed to fetch migration status."
        echo "üìù Laravel migration process completed at $(date)"